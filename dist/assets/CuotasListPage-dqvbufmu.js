import{i as j,r as P,j as a,z as p,A as E,a7 as v,c as A,B as u,T as d,I as _,C as D,D as h}from"./index--atX_XUv.js";import{d as b}from"./Refresh-Ch8CxwOq.js";import{A as T}from"./AppTable-CM16yi9f.js";import{A as m}from"./AppButton-DGApZOMm.js";import{u as I}from"./useConfirmationDialog-D18w31vS.js";import{a as O,f as k}from"./format-DtUmTUMm.js";import{T as S}from"./Tooltip-CL_KIFp2.js";import{D as N,a as R,b as M,c as B}from"./DialogTitle-DEFYoEti.js";import"./Button-C1kfnTXj.js";var f={},V=j;Object.defineProperty(f,"__esModule",{value:!0});var g=f.default=void 0,z=V(P()),H=a;g=f.default=(0,z.default)((0,H.jsx)("path",{d:"M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2m0 14H4v-6h16zm0-10H4V6h16z"}),"Payment");function q(e){return{id:e.ID_CUOTA??e.id_cuota,idPrestamo:e.ID_PRESTAMO??e.id_prestamo,idPrestatario:e.ID_PRESTATARIO??e.id_prestatario,monto:e.MONTO??e.monto,nroCuota:e.NRO_CUOTA??e.nro_cuota,fechaPago:e.FECHA_PAGO??e.fecha_pago??null,fechaVencimiento:e.FECHA_VENCIMIENTO??e.fecha_vencimiento,estado:e.ESTADO??e.estado}}function x(e){return(e||[]).map(q)}async function F(){const e=await p.get("/api/cuotas/pendientes");if(!e.data.ok)throw new Error(e.data.error||"Error al obtener cuotas pendientes");return x(e.data.result)}async function L(){const e=await p.get("/api/cuotas/morosas");if(!e.data.ok)throw new Error(e.data.error||"Error al obtener cuotas morosas");return x(e.data.result)}async function U(e,s){const o=await p.post(`/api/cuotas/${e}/pagar`,s);if(!o.data.ok)throw new Error(o.data.error||"Error al registrar pago de cuota");return o.data.result}const $=E((e,s)=>({items:[],loading:!1,error:void 0,async fetchByPrestamo(o){e({loading:!0,error:void 0});try{const[r,t]=await Promise.all([F(),L()]),l=[...r,...t].filter(n=>n.idPrestamo===o);e({items:l,loading:!1})}catch(r){e({error:r.message??"Error al cargar cuotas",loading:!1})}},async pagarCuota(o,r){e({loading:!0,error:void 0});try{await U(o,r);const t=s().items[0];t?await s().fetchByPrestamo(t.idPrestamo):e({loading:!1})}catch(t){e({error:t.message??"Error al pagar cuota",loading:!1})}}})),ee=()=>{const{idPrestamo:e}=v(),{items:s,loading:o,error:r,fetchByPrestamo:t,pagarCuota:l}=$(),n=I();A.useEffect(()=>{e&&t(Number(e)).catch(()=>{})},[e,t]);const C=i=>{n.ask("¿Confirmas el pago de esta cuota?",()=>{const c=new Date().toISOString().slice(0,10);l(i,{fecha_pago:c}).catch(()=>{})})};return a.jsxs(u,{children:[a.jsxs(u,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:[a.jsxs(d,{variant:"h5",children:["Cuotas del préstamo #",e]}),a.jsx(_,{color:"primary",onClick:()=>e&&t(Number(e)),children:a.jsx(b,{})})]}),a.jsxs(d,{variant:"body2",color:"text.secondary",mb:2,children:["Aquí puedes ver las cuotas del préstamo seleccionado. Las cuotas vencidas se marcan como"," ",a.jsx("strong",{children:"MOROSAS"}),". Solo puedes registrar pagos sobre cuotas en estado"," ",a.jsx("strong",{children:"PENDIENTE"}),"."]}),o&&a.jsx(u,{display:"flex",justifyContent:"center",my:4,children:a.jsx(D,{})}),r&&a.jsx(h,{severity:"error",sx:{mb:2},children:r}),!o&&s.length===0&&!r&&a.jsx(d,{variant:"body2",children:"No hay cuotas pendientes o morosas para este préstamo."}),!o&&s.length>0&&a.jsx(T,{columns:[{key:"nroCuota",header:"N°"},{key:"monto",header:"Monto",render:i=>O(i.monto)},{key:"fechaVencimiento",header:"Vencimiento",render:i=>k(i.fechaVencimiento)},{key:"estado",header:"Estado"},{key:"acciones",header:"Acciones",render:i=>{const c=i.estado==="PENDIENTE",y=c?"Registrar el pago de una cuota pendiente.":"Solo puedes pagar cuotas pendientes.";return a.jsx(S,{title:y,children:a.jsx("span",{children:a.jsx(m,{size:"small",startIcon:a.jsx(g,{fontSize:"small"}),onClick:()=>c&&C(i.id),disabled:!c,children:"Pagar"})})})}}],data:s}),a.jsxs(N,{open:n.open,onClose:n.cancel,children:[a.jsx(R,{children:"Confirmar pago de cuota"}),a.jsxs(M,{children:[a.jsx(d,{variant:"body2",mb:2,children:n.message}),r&&a.jsx(h,{severity:"error",children:r})]}),a.jsxs(B,{children:[a.jsx(m,{variant:"text",onClick:n.cancel,children:"Cancelar"}),a.jsx(m,{onClick:n.confirm,children:"Confirmar"})]})]})]})};export{ee as CuotasListPage,ee as default};
